#import paho.mqtt.publish as publish
#import time
class Comunic_ThingSpeak:

    def __init__(self, ritardo):
    ###   Start of user configuration   ###
        self.ritardo = ritardo
        #  ThingSpeak Channel Settings

        # The ThingSpeak Channel ID
        channelID = "1030386"

        # The Write API Key for the channel
        apiKey = "G54YTEUG4KX0I8EW"

        #  MQTT Connection Methods

        # Set useUnsecuredTCP to True to use the default MQTT port of 1883
        # This type of unsecured MQTT connection uses the least amount of system resources.
        useUnsecuredTCP = False

        # Set useUnsecuredWebSockets to True to use MQTT over an unsecured websocket on port 80.
        # Try this if port 1883 is blocked on your network.
        useUnsecuredWebsockets = False

        # Set useSSLWebsockets to True to use MQTT over a secure websocket on port 443.
        # This type of connection will use slightly more system resources, but the connection
        # will be secured by SSL.
        useSSLWebsockets = True

        ###   End of user configuration   ###

        # The Hostname of the ThinSpeak MQTT service
        mqttHost = "mqtt.thingspeak.com"

        # Set up the connection parameters based on the connection type
        if useUnsecuredTCP:
            tTransport = "tcp"
            tPort = 1883
            tTLS = None

        if useUnsecuredWebsockets:
            tTransport = "websockets"
            tPort = 80
            tTLS = None

        if useSSLWebsockets:
            import ssl

            tTransport = "websockets"
            tTLS = {'ca_certs': "/etc/ssl/certs/ca-certificates.crt", 'tls_version': ssl.PROTOCOL_TLSv1}
            tPort = 443

        # Create the topic string
        topic = "channels/" + channelID + "/publish/" + apiKey

        # invio a entrambi i canali il ritardo, uno dei due grafici mi far√†
        # direttamente la media

        tPayload = "field1=" + str(self.ritardo) + "&field2=" + str(self.ritardo)
        # attempt to publish this data to the topic
        try:
            publish.single(topic, payload=tPayload, hostname=mqttHost, port=tPort, tls=tTLS, transport=tTransport)
            time.sleep(20)

        except (KeyboardInterrupt):
            break

        except:
            print("There was an error while publishing the data.")
            time.sleep(0.5)
